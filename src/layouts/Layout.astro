---
import global from "~/styles/global.css?url";
import { Font } from "astro:assets";
import Content from "@sections/layout/Content.astro";
import { google } from "googleapis";

interface Props {
  title: string;
  desc: string;
  sections?: SectionMeta[];
  startPos?: Pos;
  schemas: any[] | any;
}

const {
  title,
  desc,
  startPos,
  sections,
  schemas: extraSchema = [],
} = Astro.props;
const extraSchemas = Array.isArray(extraSchema) ? extraSchema : [extraSchema];

import { marked } from "marked";
import { getImage } from "astro:assets";

import business from "@root/content/business.json";

import faviconSvgSrc from "~/icons/favicon.svg";
const faviconSvg = await getImage({ src: faviconSvgSrc, format: "svg" });

import { pngIcons } from "~/pages/manifest.json.ts";
import type { Pos } from "@sections/styles";
import type { SectionMeta } from "@sections/registry";
import { querySections } from "@sections/registry";
const resolvedIcons = await pngIcons;

const reviews = querySections(sections, "Reviews");

const faq = querySections(sections, "Faq");
if (faq.length > 0) {
  extraSchemas.push({
    "@type": "FAQPage",
    "@context": "https://schema.org",
    mainEntity: faq.flatMap((faq) =>
      faq.content.map((content) => ({
        "@type": "Question",
        name: content.title,
        acceptedAnswer: {
          "@type": "Answer",
          text: marked.parse(content.desc),
        },
      })),
    ),
    provider: {
      "@type": business["@type"],
      "@id": `${Astro.url.origin}#company`,
    },
  });
}

const cardshow = querySections(sections, "Cardshow");

const videoIds = cardshow
  .flatMap((section) => section.content)
  .map((item) => item.media)
  .filter((media) => media?.type === "yt-video")
  .map((media) => media.id);

const YOUTUBE_API_KEY = import.meta.env.YOUTUBE_API_KEY;
if (videoIds.length > 0 && YOUTUBE_API_KEY != null) {
  const youtube = google.youtube({
    version: "v3",
    auth: YOUTUBE_API_KEY,
  });
  const response = await youtube.videos.list({
    part: ["snippet"],
    id: videoIds,
  });

  const data = response.data;
  if (data?.items?.length) {
    data.items.map((video) =>
      extraSchemas.push({
        "@type": "VideoObject",
        name: video.snippet?.title || null,
        description: video.snippet?.description || null,
        uploadDate: video.snippet?.publishedAt || null,
        thumbnailUrl:
          video.snippet?.thumbnails?.maxres?.url ||
          video.snippet?.thumbnails?.high?.url ||
          `https://img.youtube.com/vi/${video.id}/maxresdefault.jpg`,
        embedUrl: `https://www.youtube.com/embed/${video.id}`,
        contentUrl: `https://www.youtube.com/watch?v=${video.id}`,
        publisher: {
          "@type": "Organization",
          name: video.snippet?.channelTitle || null,
          identifier: video.snippet?.channelId || null,
        },
        keywords: video.snippet?.tags?.join(", ") || null,
        inLanguage: video.snippet?.defaultAudioLanguage || null,
      }),
    );
  }
}

const schema = {
  "@id": `${Astro.url.origin}#company`,
  "@context": "https://schema.org",
  url: `${Astro.url.origin}${Astro.url.pathname}`,
  ...business,
  sameAs: [
    ...(business.sameAs || []),
    ...business.socials.map((social) => social.url),
  ],
  ...(reviews.length > 0 && {
    review: reviews.flatMap((review) =>
      review.content.map((content) => ({
        "@type": "Review",
        author: {
          "@type": "Person",
          name: content.title,
        },
        itemReviewed: {
          "@type": business["@type"],
          "@id": `${Astro.url.origin}#company`,
        },
        contentLocation: {
          "@type": "Place",
          name: content.location,
        },
        reviewRating: {
          "@type": "Rating",
          ratingValue: content.stars,
          bestRating: 5,
        },
        reviewBody: marked.parseInline(content.desc) as string,
        ...(content.date && { datePublished: content.date.toISOString() }),
        ...(content.url && {
          associatedMedia: {
            "@type": "MediaObject",
            associatedArticle: content.url,
          },
        }),
      })),
    ),
    aggregateRating: {
      "@type": "AggregateRating",
      ratingValue: parseFloat(
        (
          reviews
            .flatMap((review) => review.content)
            .reduce((total, content) => total + content.stars, 0) /
          reviews.flatMap((review) => review.content).length
        ).toFixed(1),
      ),
      reviewCount: reviews.length,
      bestRating: 5,
      worstRating: 0,
      itemReviewed: {
        "@type": business["@type"],
        "@id": `${Astro.url.origin}#company`,
      },
    },
  }),
};
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title slot="head">
      {title ? `${title} | ${business.name}` : business.name}
    </title>

    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(schema)}
    />

    {
      extraSchemas.map((schema) => (
        <script
          is:inline
          type="application/ld+json"
          set:html={JSON.stringify({
            "@context": "https://schema.org",
            ...schema,
          })}
        />
      ))
    }

    <meta name="description" content={desc} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href={global} />
    <Font cssVariable="--font-cormorant" />
    <Font cssVariable="--font-dm-sans" />

    <link rel="icon" type="image/svg+xml" href=`${faviconSvg.src}` />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    {
      resolvedIcons.map((icon: any) => (
        <>
          <link rel="apple-touch-icon" sizes={icon.sizes} href={icon.src} />
          <link
            rel="icon"
            type="image/png"
            sizes={icon.sizes}
            href={icon.src}
          />
        </>
      ))
    }

    <script src="~/frontend/index.ts"></script>
  </head>
  <body>
    <slot name="before" />
    <Content startPos={startPos ?? "right"} {sections} />
    <slot />
  </body>
</html>
