---
import clsx from "clsx";
import { getCollection } from "astro:content";

import Container, { ContainerVariant } from "~/components/div/Container.astro";
import ArrowDown from "~/assets/arrow_down.svg";

const mobileMenu = crypto.randomUUID();
const servicesDesktopMenu = crypto.randomUUID();
const servicesMobileMenu = crypto.randomUUID();

const serviceData = await getCollection("services");

interface NavItem {
  id: string;
  name: string;
}

interface Props {
  items: NavItem[];
  sticky: boolean;
}

const { items = [{}], sticky = false } = Astro.props as Props;
---

<header
  class={clsx(
    `w-full top-0 z-4`,
    sticky
      ? "sticky backdrop-blur-[20rem] py-2"
      : "absolute bg-white lg:bg-transparent py-2",
  )}
>
  {
    sticky && (
      <div class="absolute inset-0 z-[-1] bg-white opacity-50 mix-blend-screen"></div>
    )
  }
  <Container
    as="div"
    variant={ContainerVariant.Inner}
    class="z-3 flex items-center justify-between rounded-md"
  >
    <h1 class="text-accent-dark font-serif text-3xl font-bold">Strataline</h1>
    <nav>
      <ul class="hidden gap-10 lg:flex">
        <li>
          <button
            class="flex cursor-pointer items-center"
            onclick={`toggleDropdown(this)`}
          >
            <span class="text-bg font-sans">Services</span>
            <ArrowDown class="ml-3 w-4" />
          </button>

          <div
            id={servicesDesktopMenu}
            data-safari-bad="transition-all duration-200"
            class="px-inset max-w-inner pointer-events-none absolute top-full left-1/2 w-full -translate-x-1/2 -translate-y-10 opacity-0 [&.active]:pointer-events-auto [&.active]:translate-y-0 [&.active]:opacity-100"
          >
            <ul
              class="bg-tone p-inset gap-inset flex flex-wrap justify-evenly rounded-md"
            >
              {
                serviceData.map((service: any, _) => (
                  <li>
                    <a
                      href={`/services/${service.slug}`}
                      class="text-bg font-sans"
                    >
                      {service.data.title}
                    </a>
                  </li>
                ))
              }
            </ul>
          </div>
        </li>

        {
          items.length !== 0
            ? items.map((item) => (
                <li>
                  <a href={`#${item.id}`} class="text-bg font-sans">
                    {item.name}
                  </a>
                </li>
              ))
            : null
        }
      </ul>
      <div class="lg:hidden">
        <button
          data-idx={mobileMenu}
          onclick={`toggleMenu('${mobileMenu}', '${sticky}')`}
          class="burger h-9 w-9 cursor-pointer"></button>
      </div>
    </nav>
  </Container>
</header>

<div
  data-safari-bad="transition-transform duration-300"
  class="pointer-events-none fixed inset-0 z-3 flex -translate-x-full overflow-scroll bg-white xl:hidden [&.active]:pointer-events-auto [&.active]:translate-x-0"
  id={mobileMenu}
>
  <ul class="m-auto flex w-full max-w-200 flex-col gap-6 py-30 pl-8">
    {
      items.length !== 0
        ? items.map((item) => (
            <li>
              <a href={`#${item.id}`} class="font-sans text-lg">
                {item.name}
              </a>
            </li>
          ))
        : null
    }

    <li>
      <button
        class="flex cursor-pointer items-center"
        onclick={`toggleDropdown(this)`}
      >
        <span class="font-sans text-xl">Services </span>
        <ArrowDown class="ml-3 w-5" />
      </button>

      <div
        id={servicesMobileMenu}
        class="hidden w-fit transition-transform duration-500 [&.active]:block"
      >
        <ul class="bg-tone my-5 flex flex-col gap-8 rounded-md p-5">
          {
            serviceData.map((service: any, _) => (
              <li>
                <a href={`/services/${service.slug}`} class="font-sans text-xl">
                  {service.data.title}
                </a>
              </li>
            ))
          }
        </ul>
      </div>
    </li>
  </ul>
</div>

<style lang="scss">
  .burger {
    position: relative;
    display: flex;

    &::after,
    &::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      background: var(--color-black);
      height: 2px;
      transform-origin: center;
      transition:
        transform 250ms ease,
        left 250ms ease;
    }

    &::before {
      transform: translateY(-7px);
    }

    &::after {
      transform: translateY(7px);
      left: 30%;
    }

    &.active {
      &::after {
        transform: rotate(45deg);
        left: 0;
      }

      &::before {
        transform: rotate(-45deg);
      }
    }
  }

  a {
    position: relative;
    &::after {
      content: "";
      position: absolute;
      bottom: -0.4rem;
      right: 10%;
      left: 10%;
      transform: scaleX(0);
      height: 1px;
      background: var(--color-black);
      transition: transform 200ms ease-in-out;
      opacity: 0.5;
    }
    &:hover::after {
      transform: scaleX(1);
    }
  }
</style>
