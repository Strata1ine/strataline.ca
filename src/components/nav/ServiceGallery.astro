---
import clsx from "clsx";
import Container, { ContainerVariant } from "~/components/div/Container.astro";
import ContainerTitle from "~/components/div/ContainerTitle.astro";

import { getImage } from "astro:assets";
import { Icon } from "astro-icon/components";

const {
  title = "There's more to explore",
  titlePos = Astro.locals.getNextPos(),
  class: customClass,
  exclude = [],
  ...slot
} = Astro.props;

const services = Astro.locals.services.filter(
  (service) => !exclude.some((pattern: any) => service.slug.includes(pattern)),
);

// WARN: https://github.com/withastro/roadmap/pull/1051#issuecomment-2707323216
const images = await Promise.all(
  services.map(async (service) => {
    return await getImage({
      src: service.data.covers[0].src,
      format: "webp",
      quality: 20,
    });
  }),
);
---

<Container
  class={clsx(`contain-paint`, customClass)}
  variant={ContainerVariant.Max}
  {...slot}
>
  <ContainerTitle center class="px-inset" title={title} titlePos={titlePos} />

  <slot name="top" />
  <div class="bg-accent">
    <Container
      class="flex flex-wrap justify-center gap-6 py-22 sm:gap-y-12 2xl:gap-8"
      variant={ContainerVariant.Inner}
      as="div"
    >
      {
        services.map((service: any, i: number) => (
          <a
            href={`/services/${service.slug}`}
            id={service.slug}
            class="flex items-center gap-3 sm:max-w-1/2 sm:flex-[40%] sm:flex-col sm:items-baseline lg:max-w-1/3 lg:flex-[30%]"
            data-astro-prefetch
          >
            <img
              src={images[i].src}
              srcset={images[i].srcSet.attribute}
              class="min-h-30 w-1/2 rounded-sm object-cover transition duration-300 hover:scale-[1.05] sm:h-65 sm:w-full"
              alt={service.data.covers[0].alt}
              loading="lazy"
            />

            <div class="flex flex-col gap-2 sm:w-full sm:flex-row sm:items-center">
              <h3 class="font-serif text-xl">{service.data.title}</h3>
              <Icon name="arrow" class="w-13" />
            </div>
          </a>
        ))
      }
    </Container>
  </div>

  <slot name="bottom" />
</Container>
