---
import { containerStyles, imageStyles } from "./styles";
import { swapPos } from "./pos";
import { getEntry, getCollection } from "~/content.config";
import { Image } from "astro:assets";

import LayoutDivider from "./layout/Divider.astro";
import LayoutTitle from "./layout/Title.astro";
import LayoutCard from "./layout/Card.astro";

let index = await getEntry("index", "index");

import { actionStyles } from "@actions/styles";

import { type PropsOf } from "./registry";
const meta = Astro.props as PropsOf<"Popular">;

const services = (await getCollection("services"))
  .filter((service) =>
    index.data.popular.some((pattern: string) =>
      service.id.split("/")[0].includes(pattern),
    ),
  )
  .sort(
    (a, b) =>
      index.data.popular.indexOf(a.id) - index.data.popular.indexOf(b.id),
  );

let next = swapPos(meta.pos);
---

<LayoutDivider id={meta.id}>
  <LayoutTitle title={meta.title} pos={meta.pos} />

  <div class={containerStyles({ width: "outer" })}>
    {
      services.map((service, _) => {
        const slug = service.id.split("/")[0];
        next = swapPos(next);

        return (
          <LayoutCard
            id={slug}
            title={service.data.title}
            desc={service.data.desc}
            pos={next}
          >
            {service.data.covers.map((image, _) => (
              <Image
                slot="image"
                class={imageStyles({
                  anim: service.data.covers.length > 1 ? "zoom" : undefined,
                })}
                src={image.meta}
                alt={image.alt}
                draggable={false}
                widths={[500, 750, 1300, 2160]}
                sizes="100vw"
                width={2160}
              />
            ))}

            <div class="mt-8">
              <a
                class={actionStyles()}
                href={`/services/${slug}`}
                rel="noopener noreferrer"
                data-astro-prefetch=""
              >
                Explore More
              </a>
            </div>
          </LayoutCard>
        );
      })
    }
  </div>
</LayoutDivider>
