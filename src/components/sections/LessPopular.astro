---
import { container, heading, Pos } from "./meta";
import { Image } from "astro:assets";
import { optimizeOpts } from "~/build/images";
import clsx from "clsx";

import { Icon } from "astro-icon/components";
import { type LessPopular as Meta } from "@/meta";
import TextCarousel from "./TextCarousel.astro";
import Title from "./Title.astro";

import { getIndex, getServices } from "~/content.config.ts";
let index = await getIndex();
let services = await getServices();

interface Props {
  meta: Meta;
  pos: Pos;
}

const { meta, pos = Astro.locals.getNextPos() } = Astro.props;

const exclude = index.data.popular;

const lessPopularServices = services.filter(
  (service) =>
    !exclude.some((pattern: string) =>
      service.id.split("/")[0].includes(pattern),
    ),
);
---

<section class={container({ intent: "div" })} id={meta.id}>
  <Title title={meta.title} {pos} />

  <div class="bg-accent">
    <nav
      class={clsx(
        container({ intent: "inner" }),
        "flex flex-wrap justify-center gap-6 py-12 md:py-22 sm:gap-y-12 2xl:gap-7",
      )}
    >
      {
        lessPopularServices.map((service, _) => {
          const slug = service.id.split("/")[0];
          return (
            <a
              class="gap-inset flex w-full items-center sm:max-w-1/2 sm:flex-[40%] sm:flex-col lg:max-w-1/3 lg:flex-[30%]"
              href={`/services/${slug}`}
            >
              <Image
                class="h-[30vw] max-h-65 min-h-30 w-1/2 rounded-sm object-cover transition duration-300 select-none hover:scale-[1.05] sm:w-full"
                src={service.data.covers[0].meta}
                alt={service.data.covers[0].alt}
                {...optimizeOpts}
              />

              <div class="sm:gap-inset flex flex-col gap-1 sm:w-full sm:flex-row sm:items-center">
                <h3 class={heading({ intent: "xl" })}>{service.data.title}</h3>
                <Icon name="arrow" is:inline />
              </div>
            </a>
          );
        })
      }
    </nav>
  </div>

  {meta.carousel && <TextCarousel meta={meta.carousel} />}
</section>
