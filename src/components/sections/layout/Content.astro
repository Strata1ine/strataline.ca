---
import { type SectionMeta, sectionRegistry } from '@/components/registry';
import { type Pos, swapPos } from '../styles';

type Props = {
	sections?: SectionMeta[];
	startPos: Pos;
};

let { sections, startPos } = Astro.props;
let pos: Pos = swapPos(startPos);

const builtSections =
	sections != null
		? await Promise.all(
				sections.map(async (props) => {
					let section = await sectionRegistry[props.type]?.load();

					if (section == null) {
						console.warn(`Component: ${props.type} couldn't load. This is likely a bug from cache`);
						return;
					}

					if (!section.default) {
						console.log(
							`Failed to render: ${props.type}. There is likely a syntax error that is not being reported.`,
						);
						return null;
					}

					return {
						component: section,
						props,
					};
				}),
			)
		: [];
---

{
	builtSections.map((data) => {
		if (!data) return null;

		if ('pos' in data.props) {
			data.props.pos = swapPos(pos);
			pos = data.props.pos as Pos;
		}

		startPos = pos;

		return <data.component.default {...data.props} />;
	})
}
