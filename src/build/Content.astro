---
import { type SchemaRegistry, componentRegistry } from "~/build/components";
import { type Pos, swapPos } from "@sections/styles";

type Props = {
  components?: SchemaRegistry;
  startPos: Pos;
};

let { components, startPos } = Astro.props;
let pos: Pos = swapPos(startPos);

const builtComponents =
  components != null
    ? await Promise.all(
        components.map(async (props) => {
          let component = await componentRegistry[props.type]?.load();

          if (component == null) {
            console.warn(
              `Component: ${props.type} couldn't load. This is likely a bug from cache`,
            );
            return;
          }

          if (!component.default) {
            console.log(
              `Failed to render: ${props.type}. There is likely a syntax error that is not being reported.`,
            );
            return null;
          }

          return {
            component,
            props,
          };
        }),
      )
    : [];
---

{
  builtComponents.map((data) => {
    if (!data) return null;

    if ("pos" in data.props) {
      data.props.pos = swapPos(pos);
      pos = data.props.pos as Pos;
    }

    startPos = pos;

    return <data.component.default {...data.props} />;
  })
}
