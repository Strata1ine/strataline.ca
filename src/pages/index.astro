---
import { getCollection } from "astro:content";
import Header from "~/components/nav/Header.astro";
import Layout from "~/layouts/Layout.astro";

const [index] = await getCollection("index");
const serviceData = await getCollection("services");
const { Content } = await index.render();

const business = index.data.business;

import logo from "~/icons/logo.svg";

function generateSchema(data: any) {
  const schema = {
    "@context": "https://schema.org",
    "@type": data.schema_type,
    url: Astro.url.origin,
    logo: logo.src.split("?")[0],
  };

  Object.assign(schema, data);

  schema.makesOffer = serviceData.map((service) => ({
    "@type": "Offer",
    itemOffered: {
      "@type": "Service",
      name: service.data.title,
      description: service.data.description,
      image: service.data.covers?.[0]?.src.src.split("?")[0] || null,
    },
  }));

  if (schema.sameAs) {
    schema.sameAs = schema.sameAs.map((item) => item.url);
  }

  return schema;
}
---

<Layout title={index.data.title} brand>
  {
    (
      <script
        slot="head"
        type="application/ld+json"
        set:html={JSON.stringify(generateSchema(business), null, 2)}
      />
    )
  }

  <meta slot="head" name="description" content={index.data.description} />

  {index.data.header && <Header items={index.data.header.ref} />}
  <Content />
</Layout>
