---
import Header from "~/components/nav/Header.astro";
import Layout from "~/layouts/Layout.astro";

const { index, services } = Astro.locals;

import * as index_raw_data from "~/content/index/index.mdx";
import logo from "~/icons/logo.svg";
import { getImage } from "astro:assets";

const serviceCovers = await Promise.all(
  services.map(async (service) => {
    if (service.data.covers[0]?.src) {
      const image = await getImage({
        src: service.data.covers[0].src,
        width: 2160,
        format: "webp",
      });
      return image.src;
    }

    return null;
  }),
);

function schema() {
  const schema = {
    "@context": "https://schema.org",
    "@type": index.data.schema_type,
    "@id": `${Astro.url.origin}#company`,
    url: Astro.url.origin,
    logo: `${Astro.url.origin}${logo.src.split("?")[0]}`,
  };

  Object.assign(schema, index_raw_data.frontmatter.business);

  schema.makesOffer = services.map((service: any, i: number) => ({
    "@type": "Offer",
    itemOffered: {
      "@type": "Service",
      name: service.data.title,
      description: service.data.description,
      image: {
        "@type": "ImageObject",
        url: `${Astro.url.origin}${serviceCovers[i] || null}`,
        description: service.data.covers[0]?.alt || null,
      },
    },
  }));

  if (schema.sameAs) {
    schema.sameAs = schema.sameAs.map((item) => item.url);
  }

  return schema;
}

const { Content } = await index.render();
---

<Layout
  title={index.data.title}
  description={index.data.description}
  generateSchema={schema}
>
  {index.data.header && <Header items={index.data.header.ref} />}

  <Content />
</Layout>
