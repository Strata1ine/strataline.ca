---
import Header from "~/components/nav/Header.astro";
import Layout from "~/layouts/Layout.astro";

const { index, services, reviewData } = Astro.locals;
const { Content } = await index.render();

import logo from "~/icons/logo.svg";

function generateSchema() {
  const schema = {
    "@context": "https://schema.org",
    "@type": index.data.schema_type,
    "@id": `${Astro.url.origin}#company`,
    url: Astro.url.origin,
    logo: logo.src.split("?")[0],
    ...(reviewData.length > 0 ? { review: reviewData } : {}),
  };

  console.log(reviewData);

  Object.assign(schema, index.data.business);

  schema.makesOffer = services.map((service) => ({
    "@type": "Offer",
    itemOffered: {
      "@type": "Service",
      name: service.data.title,
      description: service.data.description,
      image: {
        "@type": "ImageObject",
        url: service.data.covers[0]?.src.src.split("?")[0] || null,
        description: service.data.covers[0]?.alt || null,
      },
    },
  }));

  if (schema.sameAs) {
    schema.sameAs = schema.sameAs.map((item) => item.url);
  }

  return schema;
}
---

<Layout title={index.data.title} schema={generateSchema()}>
  <meta slot="head" name="description" content={index.data.description} />

  {index.data.header && <Header items={index.data.header.ref} />}
  <Content />
</Layout>
