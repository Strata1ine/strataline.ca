---
import type { SchemaOf } from 'astro-frontmatter-components';
import { type SchemaContext, z } from 'astro:content';
import { swapPos, DefaultPos } from '@/schemas';

export const schema = (_: SchemaContext) => ({
	id: z.string().optional(),
	pos: DefaultPos,
	title: z.string(),
});

import { getEntry, getCollection } from '@/content.config';

const index = await getEntry('index', 'index');
const services = (await getCollection('services'))
	.filter((service) =>
		index.data.popular.some((pattern: string) => service.id.split('/')[0].includes(pattern)),
	)
	.sort((a, b) => index.data.popular.indexOf(a.id) - index.data.popular.indexOf(b.id));

export type Props = SchemaOf<typeof schema>;
const meta = Astro.props;
let next = swapPos(meta.pos);

import { Link } from '@/components/Actions';
import Image from '@/components/Image';
import Divider from './layout/Divider.astro';
import Title from './layout/Title.astro';
import Container from './layout/Container.astro';
import Card from './layout/Card.astro';
---

<Divider id={meta.id}>
	<Title title={meta.title} pos={meta.pos} />

	<Container width="outer" class="space-y-20 sm:space-y-35">
		{
			services.map((service, _) => {
				const slug = service.id.split('/')[0];
				next = swapPos(next);

				return (
					<Card id={slug} title={service.data.title} desc={service.data.desc} pos={next}>
						{service.data.covers.map((image, _) => (
							<Image
								image={image}
								anim={service.data.covers.length > 1 ? 'zoom' : undefined}
								widths={[400, 725, 1450]}
							/>
						))}

						<div class="mt-9">
							<Link href={`/services/${slug}`} rel="noopener noreferrer" data-astro-prefetch="">
								Explore More
							</Link>
						</div>
					</Card>
				);
			})
		}
	</Container>
</Divider>
